image: node:10.14.1

stages:
  - deploy

before_script:
  - yarn

deploy_staging:
  stage: deploy
  script:
    - rm -rf c0d3/build
    - CI=false yarn build
    - PORT=9631 forever stop -a -l /dev/null Server/app.js --silent
    - PORT=9631 forever start Server/app.js
  environment:
    name: staging
    url: https://staging.c0d3.com
  only:
  - develop
  
deploy_production:
  stage: deploy
  variables:
    NODE_ENV: production
    CLIENT_URL: https://c0d3.com
    HOST_NAME: c0d3.com
  script:
    - rm -rf build
    - CI=false yarn build
    - mv build/index.html public/root.html && rm public/index.html
    - pm2 stop all || true
    - pm2 delete all || true
    - pm2 start Server/app.js
  environment:
    name: production
    url: https://c0d3.com
  only:
  - master

